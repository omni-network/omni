version: '2.4'
networks:
  {{ .NetworkName }}:
    labels:
      e2e: true
    driver: bridge
    {{- if .Network }}
    ipam:
      driver: default
      config:
      - subnet: {{ .NetworkCIDR }}
    {{- end }}

services:
{{- range .Nodes }}
  {{ .Name }}:
    labels:
      e2e: true
    container_name: {{ .Name }}
    image: {{ .Version }}
    init: true
    ports:
    - {{ if $.BindAll }}26656:{{end}}26656
    - {{ if .ProxyPort }}{{ .ProxyPort }}:{{ end }}26657
{{- if .PrometheusProxyPort }}
    - {{ .PrometheusProxyPort }}:26660
{{- end }}
    - 6060
    volumes:
    - ./{{ .Name }}:/halo
    depends_on:
      {{ index $.NodeOmniEVMs .Name }}:
        condition: service_healthy
    networks:
      {{ $.NetworkName }}:
        {{ if $.Network }}ipv4_address: {{ .InternalIP }}{{ end }}
{{end}}

{{- range .Anvils }}
  # Initialises geth files and folder from provided genesis file.
  {{ .Chain.Name }}:
    labels:
      e2e: true
    container_name: {{ .Chain.Name }}
    image: ghcr.io/foundry-rs/foundry:latest
    entrypoint:
      - anvil
      - --host=0.0.0.0
      - --chain-id={{ .Chain.ID }}
      - --block-time={{.Chain.BlockPeriod.Seconds}}
      - --silent
      {{ if .LoadState }}- --load-state=/anvil/state.json{{ end }}
    ports:
      - {{ if .ProxyPort }}{{ .ProxyPort }}:{{ end }}8545
    networks:
      {{ $.NetworkName }}:
        {{ if $.Network }}ipv4_address: {{ .InternalIP }}{{ end }}
    {{ if .LoadState }}
    volumes:
      - {{ .LoadState }}:/anvil/state.json
    {{ end }}
{{- end}}

  # Use geth as the omni EVMs.
{{- range .OmniEVMs }}
  # Initialises geth files and folder from provided genesis file.
  {{ .InstanceName }}-init:
    labels:
      e2e: true
    container_name: {{ .InstanceName }}-init
    image: "ethereum/client-go:{{ $.GethTag }}"
    command: --state.scheme={{ if .IsArchive }}hash{{ else }}path{{ end }} --datadir=/geth init /geth/genesis.json
    volumes:
      - ./{{ .InstanceName }}:/geth
    networks:
      {{ $.NetworkName }}:

  {{ .InstanceName }}:
    labels:
      e2e: true
    container_name: {{ .InstanceName }}
    image: "ethereum/client-go:{{ $.GethTag }}"
    command:
      - --config=/geth/config.toml
      # Flags not available via config.toml
      - --nat=extip:{{ .AdvertisedIP }}
      - --pprof
      - --pprof.addr=0.0.0.0
      - --metrics
      {{ if .IsArchive }}- --gcmode=archive{{ end }}
    ports:
      - {{ if $.BindAll }}8551:{{end}}8551
      - {{ if .ProxyPort }}{{ .ProxyPort }}:{{ end }}8545
      - {{ if $.BindAll }}30303:{{end}}30303
      - 8546
      - 6060
    depends_on:
      {{ .InstanceName }}-init:
        condition: service_completed_successfully
    healthcheck:
      test: "nc -z localhost 8545"
      interval: 1s
      retries: 30
    volumes:
      - ./{{ .InstanceName }}:/geth
    networks:
      {{ $.NetworkName }}:
        {{ if $.Network }}ipv4_address: {{ .AdvertisedIP }}{{ end }}
{{end}}

{{- if .Relayer }}
  relayer:
    labels:
      e2e: true
    container_name: relayer
    image: omniops/relayer:{{or .OmniTag "main"}}
    restart: unless-stopped # Restart on crash to mitigate startup race issues
    volumes:
      - ./relayer:/relayer
    networks:
      {{ $.NetworkName }}:
        {{ if $.Network }}ipv4_address: 10.186.73.200{{ end }}
{{end}}

{{- if .Monitor }}
  monitor:
    labels:
      e2e: true
    container_name: monitor
    image: omniops/monitor:{{or .OmniTag "main"}}
    restart: unless-stopped # Restart on crash to mitigate startup race issues
    volumes:
      - ./monitor:/monitor
    networks:
      {{ $.NetworkName }}:
        {{ if $.Network }}ipv4_address: 10.186.73.201{{ end }}
{{ end }}

{{- if .ExplorerIndexer }}
  {{ if .CleanExplorerDB }}
  explorer_indexer-init:
    labels:
      e2e: true
    restart: on-failure # Do not restart under any circumstances
    container_name: explorer_indexer-init
    context: .
    dockerfile_inline: |
      FROM alpine:3.14

      # Install dependencies (including yq)
      RUN apk add --no-cache postgresql-client bash

      # Download yq binary directly
      ARG YQ_VERSION=4.9.6
      RUN wget https://github.com/mikefarah/yq/releases/${YQ_VERSION}/download/yq_linux_amd64 -O /usr/bin/yq &&\
        chmod +x /usr/bin/yq

      COPY <<EOF /clean.sql
      DROP SCHEMA public CASCADE;
      CREATE SCHEMA public;

      GRANT ALL ON SCHEMA public TO postgres;
      GRANT ALL ON SCHEMA public TO public;
      EOF

      RUN cat /clean.sql

      CMD yq -V && \
        conn_str=$(yq eval '.dburl' /explorer_indexer/indexer.toml) && \
        psql "$conn_str" -f /clean.sql
    volumes:
      - ./explorer_indexer:/explorer_indexer
    networks:
      {{ $.NetworkName }}:
  {{- end }}

  explorer_indexer:
    labels:
      e2e: true
    container_name: explorer_indexer
    image: omniops/explorer-indexer:{{or .OmniTag "main"}}
    {{- if .ExplorerMockDB}}
    command:
      - --db-url=postgres://omni:password@explorer_db:5432/omni_db
    {{- end}}
    restart: unless-stopped # Restart on crash to mitigate startup race issues
    volumes:
      - ./explorer_indexer:/explorer_indexer
    {{ if .CleanExplorerDB }}
    depends_on:
      explorer_indexer-init:
        condition: service_completed_successfully
    {{- end }}
    networks:
      {{ $.NetworkName }}:
        {{ if $.Network }}ipv4_address: 10.186.73.204{{ end }}
{{ end }}

{{- if .ExplorerGraphql }}
  explorer_graphql:
    labels:
      e2e: true
    container_name: explorer_graphql
    image: omniops/explorer-graphql:{{or .OmniTag "main"}}
    {{- if .ExplorerMockDB}}
    command:
      - --db-url=postgres://omni:password@explorer_db:5432/omni_db
    {{- end}}
    restart: unless-stopped # Restart on crash to mitigate startup race issues
    volumes:
      - ./explorer_graphql:/explorer_graphql
    networks:
      {{ $.NetworkName }}:
        {{ if $.Network }}ipv4_address: 10.186.73.203{{ end }}
    ports:
        - 59754:8080
{{ end }}

{{- if .ExplorerMockDB }}
  explorer_db:
    labels:
      e2e: true
    image: postgres:14-alpine
    container_name: explorer_db
    environment:
      POSTGRES_DB: omni_db
      POSTGRES_USER: omni
      POSTGRES_PASSWORD: password
      ports: 5432:5432
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U omni -d omni_db" ]
      interval: 3s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      {{ $.NetworkName }}:
        {{ if $.Network }}ipv4_address: 10.186.73.205{{ end }}
{{ end }}

{{- if .Prometheus }}
  prometheus:
    labels:
      e2e: true
    container_name: prometheus
    image: prom/prometheus:latest
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --web.console.libraries=/usr/share/prometheus/console_libraries
      - --web.console.templates=/usr/share/prometheus/consoles
      - --enable-feature=exemplar-storage
      - --enable-feature=agent
    restart: unless-stopped
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    networks:
      {{ $.NetworkName }}:
        {{ if $.Network }}ipv4_address: 10.186.73.202{{ end }}
{{ end }}
