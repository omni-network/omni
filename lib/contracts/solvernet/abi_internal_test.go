package solvernet

import (
	"encoding/hex"
	"encoding/json"
	"testing"

	"github.com/omni-network/omni/contracts/bindings"

	"github.com/stretchr/testify/require"
)

var data = `{
  "SrcChainId": 1652,
  "DestChainId": 1651,
  "FillDeadline": 1747218935,
  "Calls": [
    {
      "Target": "0x23618e81e3f5cdf7f54c3d65f7fbc0abf5b21e8f",
      "Selector": [0,0,0,0],
      "Value": 2000000000000000000,
      "Params": null
    }
  ],
  "Expenses": []
}`

var expectedEncoding = `49e07a76324e9d1c58f92f7772fad510457fdf09fc12ddbe4e1cb077cd4d80de00000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000674000000000000000000000000000000000000000000000000000000000000067300000000000000000000000000000000000000000000000000000000682471f700000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000023618e81e3f5cdf7f54c3d65f7fbc0abf5b21e8f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001bc16d674ec80000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000`

//nolint:musttag // Not important for testing.
func TestFillHash(t *testing.T) {
	t.Parallel()

	orderID, err := hex.DecodeString("49e07a76324e9d1c58f92f7772fad510457fdf09fc12ddbe4e1cb077cd4d80de")
	require.NoError(t, err)

	var fill bindings.SolverNetFillOriginData
	err = json.Unmarshal([]byte(data), &fill)
	require.NoError(t, err)

	encoded, err := encodeFillData(OrderID(orderID), fill)
	require.NoError(t, err)
	require.Equal(t, expectedEncoding, hex.EncodeToString(encoded))

	fillHash, err := FillHash(OrderID(orderID), fill)
	require.NoError(t, err)
	require.Equal(t, "0x2ce133fd27dd302588a6dd43d003fcbf195768e676ba8728b4198450a11c55c1", fillHash.Hex())
}
